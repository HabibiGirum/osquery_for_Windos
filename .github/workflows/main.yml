name: Windows Build

on: [push]

jobs:
  step1:
    runs-on: windows-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v2
      
    - name: Install Chocolatey
      run: |
        Set-ExecutionPolicy Bypass -Scope Process -Force; iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))
        
    - name: Install Windows Prerequisites
      run: |
        choco install cmake --version 3.21.4 -y
        choco install visualstudio2019buildtools -y
        choco install git -y
        choco install python3 --params "/InstallDir:C:\Python37" -y
        choco install wixtoolset -y
        choco install strawberryperl -y
        choco install 7zip -y
        choco install python -y
        
    - name: Configure Git for Windows
      run: |
        git config --global core.symlinks true
        git config --global core.autocrlf false

  step2:
    needs: step1
    runs-on: windows-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v2
      
    - name: Download and Build Source
      run: |
        git clone https://github.com/osquery/osquery
        cd osquery
        mkdir build
        cd build
        
        
        call "C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\VC\Auxiliary\Build\vcvars64.bat"
        
        cmake -G "Visual Studio 16 2019" -A x64 ..
        cmake --build . --config RelWithDebInfo -j10
      shell: cmd


